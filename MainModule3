return function(config,addons)
	addons.Parent.Parent = game:GetService("ServerScriptService")
	
    ------------------------------------------------------------
    -- PSEUDO-CODE: INITIAL SETUP / VARIABLES
    ------------------------------------------------------------
    -- Move the addon folder into ServerScriptService for the server to use.
    -- Pull various config settings like message editing, reply system,
    -- display names, team chat behavior, etc.
    -- Get Roblox services such as Players, ReplicatedStorage, Teams, Chat.
    -- Load ProfileService (handles saving user chat settings).
    -- Load shared utilities: networking system, signals, wrappers.
    -- Set up addon folders such as client plugins and server plugins.
    -- Load constructor objects for speaker, channel, message, poll.
    ------------------------------------------------------------

	local messageEditingPermissions = config.Messages.Extra.Editable
	local replyEnabled = config.Messages.Extra.ReplyEnabled
	local mentioningEnabled = config.Messages.Extra.MentionEnabled
	config.Polls = config.Polls or {
		Enabled = false,
		Permission = "Owner"
	}
	
	local displayNamesEnabled = config.DisplayNames.Enabled
	local teamsOverride = config.Teams.TeamColorPriority
	local teamChatEnabled = config.Teams.TeamChat

	local players = game:GetService("Players")
	local replicatedStorage = game:GetService("ReplicatedStorage")
	local teams = game:GetService("Teams")
	local chatService = game:GetService("Chat")
	local textService = game:GetService("TextService")
	local constructors

	local profileService = require(script:WaitForChild("core"):WaitForChild("services"):WaitForChild("profile"))(config,function()
		return constructors
	end)

	local sharedFolder = script:WaitForChild("shared")
	local network = require(sharedFolder:WaitForChild("network"))
	local signal = require(sharedFolder:WaitForChild("signal"))
	local wrap = require(sharedFolder:WaitForChild("wrap"))
	
	sharedFolder.Name = "betterchat_shared"
	sharedFolder.Parent = replicatedStorage
	addons:WaitForChild("Client").Parent = sharedFolder:WaitForChild("addons")

	local serverAddons = addons:WaitForChild("Server");
	serverAddons.Parent = script:WaitForChild("core")
	serverAddons.Name = "plugins"
	
	local core = script:WaitForChild("core")
	local classes = core:WaitForChild("constructors")

	local rateLimit = require(core:WaitForChild("rateLimit"))(config)
	local util = require(core:WaitForChild("utility"):WaitForChild("main"))(config)
	local permission = require(core:WaitForChild("permission"))(config)

	local cooldowns = {}
	local speakers = {}

    ------------------------------------------------------------
    -- PSEUDO-CODE: CHANNEL / SPEAKER HELPERS
    ------------------------------------------------------------
    -- fetchChannels(speaker): returns the list of channels a player is in.
    -- services table placeholder.
    -- constructors table: loads and sets up Speaker, Channel, Message, Poll.
    -- Creates API wrapper for plugins.
    -- Register remote events (receiveMessage, update, etc.).
    -- Create default main chat channel ("Main").
    -- Prepare connection tables for events and track team IDs.
    ------------------------------------------------------------

	local fetchChannels = function(speaker)
		local channels = speaker.channels
		local names = {}
		for _,channel in pairs(channels) do
			table.insert(names,channel.name)
		end
		return names
	end

	local services = {}

	constructors = {
		speaker = require(classes:WaitForChild("speaker"))(network,fetchChannels,signal),
		channel = require(classes:WaitForChild("channel"))(network,config,signal),
		message = require(classes:WaitForChild("message"))(util,config,messageEditingPermissions,permission),
		profileService = profileService,
		network = network,
		signal = signal
	}
	
	local api = require(core:WaitForChild("api"))(constructors,wrap)
	constructors.speaker:setup(constructors.channel)
	constructors.channel:setup(constructors.speaker,constructors.message)
	constructors.poll = require(classes:WaitForChild("poll"))(network,config,signal,speakers,constructors,permission)
	
	network:newEvent("receiveMessage")
	network:newEvent("receiveMessageCreation")
	network:newEvent("receiveChannelUpdate")
	network:newEvent("receiveMuteUpdate")

	local defaultChannel = constructors.channel.new("Main",true)

	local connections = {}
	local teamIds = {}

	local link = function(conns,connection)
		table.insert(conns,connection)
	end

	local getById = function(id)
		for _,plr in pairs(players:GetPlayers()) do
			if(math.abs(plr.UserId) == id) then
				return plr
			end
		end
	end

	local getTeamId = function(team)
		if(teamIds[team]) then
			return teamIds[team]
		else
			teamIds[team] = "team_" .. util:newGuid()
			return teamIds[team]
		end
	end

	local workshop = function(message)
		return message
	end

    ------------------------------------------------------------
    -- PSEUDO-CODE: PLAYER JOIN LOGIC
    ------------------------------------------------------------
    -- When a player joins:
    --   • Create a Speaker object for the player.
    --   • Apply chat appearance settings (colors, bubble chat).
    --   • Apply display name rules.
    --   • Set muted attribute.
    --   • Track changes (rename display color when name changes).
    --   • If team chat is enabled, automatically move them into
    --     a team channel when they switch teams.
    --   • Create cooldown timer for message rate limiting.
    --   • Ensure the chat system is installed for them.
    ------------------------------------------------------------

	local onPlayer = function(player)
		local name,display = player.Name,(displayNamesEnabled and player.DisplayName or player.Name)
		local _,speaker = constructors.speaker.new(name,player)
		local list = {}
		connections[player] = list
		
		if(true) then
			player:SetAttribute("BubbleBackgroundColor",config.BubbleChat.Config.BubbleBackgroundColor)
			player:SetAttribute("BubbleTextColor",config.BubbleChat.Config.BubbleTextColor)
			player:SetAttribute("TextSize",config.BubbleChat.Config.TextSize)
			player:SetAttribute("BubbleFont",config.BubbleChat.Config.BubbleFont.Name)
			player:SetAttribute("BubbleRoundness",config.BubbleChat.Config.Roundness)
		end
		
		player:SetAttribute("DisplayName",display)
		player:SetAttribute("DisplayNameColor",util:getNameColor(display))
		player:SetAttribute("NameColor",util:getNameColor(name))
		player:SetAttribute("ChatColor",Color3.fromRGB(255,255,255))
		player:SetAttribute("UseTeamColor",teamsOverride)
		player:SetAttribute("Muted",false)
		
		if(config.User.ChangeDisplayNameColorWhenAttributeChanged) then
			link(list,player:GetAttributeChangedSignal("DisplayName"):Connect(function()
				player:SetAttribute("DisplayNameColor",util:getNameColor(player:GetAttribute("DisplayName")))
			end))
			link(list,player:GetAttributeChangedSignal("Muted"):Connect(function()
				speaker:updateMuteStatus(player:GetAttribute("Muted"))
			end))
		end
		
		if(teamChatEnabled) then
			local lastTeam
			link(list,player:GetPropertyChangedSignal("Team"):Connect(function()
				pcall(function()
					
					if (lastTeam) then
						local teamId = getTeamId(lastTeam)
						lastTeam = nil
						if(table.find(fetchChannels(speakers[player]),teamId)) then
							local chatChannel = constructors.channel:getByName(teamId)
							chatChannel:removeSpeaker(speakers[player])
						end
					end
					if(player.Team ~= nil and (not player.Neutral)) then
						lastTeam = player.Team
						local teamId = getTeamId(player.Team)
						local chatChannel = constructors.channel:getByName(teamId)
						if(not chatChannel) then
							local _,new = constructors.channel.new(teamId,false)
							new:registerMessageProcess("on_create",function(message)
								message.data.isTeam = true
							end)
							chatChannel = new
						end
						chatChannel:addSpeaker(speakers[player])
					end
					
				
				end)
			end))
		end
		
		speakers[player] = speaker
		cooldowns[player] = rateLimit:createCooldown(player.UserId)
		permission:get(player.UserId)
		util:verifyChatInstalled(player)
	end
	
    ------------------------------------------------------------
    -- PSEUDO-CODE: LOAD SERVER PLUGINS
    ------------------------------------------------------------
    -- For every plugin module inside Server/plugins:
    --   • Require it
    --   • Give it access to the API
    -- Plugins customize how the chat behaves.
    ------------------------------------------------------------

	local onPlugin = function(module)
		require(module)(api)
	end
	serverAddons.ChildAdded:Connect(onPlugin)
	for _,pluginModule in pairs(serverAddons:GetChildren()) do
		task.spawn(onPlugin,pluginModule)
	end

    ------------------------------------------------------------
    -- PSEUDO-CODE: REMOTE FUNCTIONS / EVENTS
    ------------------------------------------------------------
    -- These are functions the client can call:
    --   getChannelsIn → return channels player is in
    --   requestHistory → get past messages
    --   requestConfig → send full chat config to client
    --   requestMessage → send a message (handles whisper, reply, team chat)
    --   editMessage → edit your own message
    --   typingIndicator → show typing bubble above head
    --   writeConfig → save user settings (bubble chat, UI, quick chats)
    --   fetchUserConfig → load saved settings
    ------------------------------------------------------------

	network:newFunction("getChannelsIn",function(player)
		return fetchChannels(speakers[player])
	end)

	network:newFunction("requestHistory",function(player,channel)
		...
	end)

	network:newFunction("requestConfig",function()
		return config
	end)

	network:newFunction("requestMessage",function(player,message,channel,extraData)
		------------------------------------------------------------
		-- PSEUDO-CODE:
		-- 1. Validate message text and channel name.
		-- 2. Check if message is allowed to be sent.
		-- 3. Handle Team Chat:
		--       - If tagging as team chat, force send to team channel.
		-- 4. Handle Whisper Chat:
		--       - Extract player IDs from "whisper_X_Y"
		--       - Create private channel if not created yet
		--       - Add both speakers to the whisper channel.
		-- 5. Handle Reply Chat:
		--       - Ensure message ID exists
		--       - Check cooldown
		--       - Send reply
		-- 6. Normal Message Flow:
		--       - Check channel exists
		--       - Check cooldown
		--       - Send message
		------------------------------------------------------------
		...
	end)

	network:newEvent("editMessage",function(player,id,channel,new)
		------------------------------------------------------------
		-- PSEUDO-CODE:
		-- If player has permission:
		--   • Validate new text
		--   • Get the channel
		--   • Check that the player originally sent the message
		--   • Check cooldown
		--   • Edit the message text
		------------------------------------------------------------
	end)

    ------------------------------------------------------------
    -- PSEUDO-CODE: SAVE USER CONFIG
    ------------------------------------------------------------
    -- Users can update chat settings (bubble chat, UI, quick chats).
    -- writeConfig():
    --   • Validates input
    --   • Saves to ProfileService database
    -- fetchUserConfig():
    --   • Loads saved settings when player joins
    ------------------------------------------------------------

	network:newFunction("writeConfig",function(player,location,configName,configValue)
		...
	end)

	network:newFunction("fetchUserConfig",function(player)
		...
	end)

    ------------------------------------------------------------
    -- PSEUDO-CODE: SAVE DATA
    ------------------------------------------------------------
    -- Enable profile data saving if configured.
    ------------------------------------------------------------

	if(config.User.SaveData.Enabled) then
		profileService.new(config.User.SaveData.Advanced.DatastoreName)
	end
	
    ------------------------------------------------------------
    -- PSEUDO-CODE: CLIENT SETUP
    ------------------------------------------------------------
    -- Clone the client module into StarterPlayerScripts
    -- so every player receives the chat UI client.
    ------------------------------------------------------------

	local client = script:WaitForChild("client")
	client.Name = "betterChatClient"
	client.Parent = game:GetService("StarterPlayer"):WaitForChild("StarterPlayerScripts")
	
    ------------------------------------------------------------
    -- PSEUDO-CODE: CONNECT PLAYER ADDED / REMOVED
    ------------------------------------------------------------
    -- PlayerAdded:
    --   • Setup chat speaker and attributes.
    -- PlayerRemoving:
    --   • Remove speaker
    --   • Remove connections
    --   • Clear cooldowns
    ------------------------------------------------------------

	players.PlayerAdded:Connect(onPlayer)
	for _,player in pairs(players:GetPlayers()) do
		task.spawn(onPlayer,player)
	end

	players.PlayerRemoving:Connect(function(player)
		local speaker = constructors.speaker:getByName(player.Name)
		if(speaker ~= nil) then
			speaker:Destroy()
			local list = connections[player]
			for k,conn in pairs(list) do
				conn:Disconnect()
				table.remove(list,k)
			end
			connections[player] = nil
			speakers[player] = nil
			rateLimit:unlink(player.UserId)
		end
	end)
end
